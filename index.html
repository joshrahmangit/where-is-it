<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Where is it</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9fafb; }
    h1 { text-align: center; }
    .toolbar { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
    #searchBar { flex: 1; padding: 8px; font-size: 1em; min-width: 200px; }
    button { padding: 8px 12px; font-size: 1em; cursor: pointer; }
    .danger { background:#fee2e2; border:1px solid #ef4444; color:#991b1b; }
    .primary { background:#dcfce7; border:1px solid #22c55e; color:#065f46; }
    .secondary { background:#eef2ff; border:1px solid #6366f1; color:#1e3a8a; }
    .tool-card { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; border-radius: 6px; background: #fff; }
    .tool-card img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; background:#e5e7eb; }
    .tool-info { flex: 1; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; max-width: 420px; width: 92%; border-radius: 8px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
    .voice-btn { background: #eee; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; justify-content: center; align-items: center; margin-left: 4px; }
    .muted { color:#6b7280; font-size:12px; }
    .hint { color:#374151; font-size:12px; margin-top:6px; }
    .spinner { display:none; margin-left: 8px; font-size: 12px; color:#374151; }
    .file-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>Where is it</h1>
  <div class="toolbar">
    <input id="searchBar" placeholder="Search item by name...">
    <button id="voiceSearchBtn" class="voice-btn" title="Speak search">üé§</button>
    <button id="addBtn" class="primary">Add Item</button>
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <input type="file" id="importFile" style="display:none"/>
  </div>
  <div id="toolList"></div>

  <!-- Add/Edit Item Modal -->
  <div class="modal" id="toolModal">
    <div class="modal-content">
      <h2 id="modalTitle">Add Item</h2>
      <form id="toolForm">
        <label>Item name:<br>
          <input type="text" id="toolName" required> <button type="button" class="voice-btn" id="voiceName" title="Speak name">üé§</button>
        </label><br><br>
        <label>Location:<br>
          <input type="text" id="toolLocation" required> <button type="button" class="voice-btn" id="voiceLocation" title="Speak location">üé§</button>
        </label><br><br>
        <label>Notes:<br>
          <textarea id="toolNotes"></textarea> <button type="button" class="voice-btn" id="voiceNotes" title="Speak notes">üé§</button>
        </label><br><br>

        <!-- New: two options for photo source -->
        <div>Photo:</div>
        <div class="file-row">
          <button type="button" id="btnTakePhoto" class="secondary">Take Photo</button>
          <button type="button" id="btnChoosePhoto">Choose from Library</button>
          <span id="chosenFileName" class="muted"></span>
        </div>
        <!-- Hidden inputs: one with capture for camera, one without for library -->
        <input type="file" id="toolImageCamera" accept="image/*" capture="environment" style="display:none">
        <input type="file" id="toolImageLibrary" accept="image/*" style="display:none">
        <div class="hint">On Android, ‚ÄúTake Photo‚Äù opens the camera. ‚ÄúChoose from Library‚Äù lets you pick existing photos.</div>

        <div class="muted" style="margin-top:6px;">Leave photo empty when editing to keep the current picture.</div>
        <div class="modal-actions">
          <button type="submit" class="primary" id="saveBtn">Save</button>
          <span class="spinner" id="saveSpinner">Processing photo‚Ä¶</span>
          <button type="button" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Item Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <h2 id="detailName"></h2>
      <p><strong>Location:</strong> <span id="detailLocation"></span></p>
      <p><strong>Notes:</strong> <span id="detailNotes"></span></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <img id="detailImage" src="" alt="" style="max-width:100%; height:auto; border-radius:6px; display:none; border:1px solid #ddd;">
      </div>
      <div class="modal-actions">
        <button id="copyLocationBtn">Copy Location</button>
        <button id="editBtn" class="primary">Edit</button>
        <button id="deleteBtn" class="danger">Delete</button>
        <button id="closeDetailBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /*** Simple IndexedDB wrapper (stores big photo blobs safely) ***/
    const DB_NAME = 'wiwi-db';
    const DB_STORE = 'images';
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function putImage(id, blob) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).put(blob, id);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
    async function getImage(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, 'readonly');
        const req = tx.objectStore(DB_STORE).get(id);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }
    async function deleteImage(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).delete(id);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    /*** State ***/
    let tools = JSON.parse(localStorage.getItem("tools")||"[]"); // [{id, name, location, notes, imageThumb?}]
    let editingIndex = null;
    let viewingIndex = null;
    let selectedFile = null; // NEW: holds whichever input (camera or library) user picked

    const toolList = document.getElementById("toolList");
    const toolModal = document.getElementById("toolModal");
    const detailModal = document.getElementById("detailModal");
    const saveBtn = document.getElementById("saveBtn");
    const saveSpinner = document.getElementById("saveSpinner");
    const chosenFileName = document.getElementById("chosenFileName");

    /*** UI helpers ***/
    function showModal(m){ m.style.display="flex"; }
    function closeModal(m){ m.style.display="none"; }
    function escapeHtml(s){ return (s||"").replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
    function uid(){ return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); }

    /*** Render list ***/
    function renderTools(){
      toolList.innerHTML = "";
      tools.forEach((t,i)=>{
        const card = document.createElement("div");
        card.className = "tool-card";
        const img = document.createElement("img");
        img.src = t.imageThumb || "";
        img.alt = t.name?.[0] || "";
        const info = document.createElement("div");
        info.className = "tool-info";
        info.innerHTML = `<strong>${escapeHtml(t.name)}</strong><br>${escapeHtml(t.location)}`;
        card.appendChild(img);
        card.appendChild(info);
        card.onclick = ()=> showDetail(i);
        toolList.appendChild(card);
      });
      localStorage.setItem("tools", JSON.stringify(tools));
    }

    /*** Open/Close modals ***/
    document.getElementById("addBtn").onclick=()=>{
      editingIndex=null;
      selectedFile=null;
      chosenFileName.textContent="";
      document.getElementById("toolForm").reset();
      document.getElementById("modalTitle").innerText="Add Item";
      showModal(toolModal);
    };
    document.getElementById("cancelBtn").onclick=()=>closeModal(toolModal);

    /*** Photo source controls ***/
    const inputCam = document.getElementById("toolImageCamera");
    const inputLib = document.getElementById("toolImageLibrary");
    document.getElementById("btnTakePhoto").onclick = ()=> inputCam.click();
    document.getElementById("btnChoosePhoto").onclick = ()=> inputLib.click();
    const handleFilePick = (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      selectedFile = f;
      chosenFileName.textContent = f.name ? `Selected: ${f.name}` : "Selected photo";
    };
    inputCam.addEventListener('change', handleFilePick);
    inputLib.addEventListener('change', handleFilePick);

    /*** Image processing (resize/compress) ***/
    function imageFileToCanvasBlob(file, maxDim=1280, quality=0.7){
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("Failed to read image"));
        reader.onload = () => {
          img.onload = () => {
            try{
              const {width, height} = img;
              const scale = Math.min(1, maxDim / Math.max(width, height));
              const w = Math.round(width * scale);
              const h = Math.round(height * scale);
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, w, h);
              canvas.toBlob(blob => {
                if(!blob) return reject(new Error("Failed to encode image"));
                resolve({blob, dataURL: canvas.toDataURL('image/jpeg', 0.5)}); // small thumb
              }, 'image/jpeg', quality);
            }catch(e){ reject(e); }
          };
          img.onerror = () => reject(new Error("Invalid image"));
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    /*** Save (Add/Edit) ***/
    document.getElementById("toolForm").onsubmit=async (e)=>{
      e.preventDefault();
      const name=document.getElementById("toolName").value.trim();
      const location=document.getElementById("toolLocation").value.trim();
      const notes=document.getElementById("toolNotes").value.trim();
      const file=selectedFile; // use whichever source the user chose

      if(!name || !location){ alert("Please enter a name and a location."); return; }

      saveBtn.disabled = true;
      saveSpinner.style.display = 'inline';

      try{
        let imageThumb = null;
        let newBlob = null;

        if(file){
          const processed = await imageFileToCanvasBlob(file, 1280, 0.7);
          newBlob = processed.blob;            // compressed big photo
          imageThumb = processed.dataURL;      // small dataURL for list/detail preview
        }

        if(editingIndex!=null){
          const prev = tools[editingIndex] || {};
          const id = prev.id || uid();
          const updated = {
            ...prev,
            id, name, location, notes,
            imageThumb: (imageThumb !== null ? imageThumb : prev.imageThumb || null)
          };
          tools[editingIndex] = updated;
          if(newBlob){ await putImage(id, newBlob); }
        } else {
          const id = uid();
          const item = { id, name, location, notes, imageThumb };
          tools.push(item);
          if(newBlob){ await putImage(id, newBlob); }
        }

        localStorage.setItem("tools", JSON.stringify(tools));
        renderTools();
        closeModal(toolModal);
      }catch(err){
        console.error(err);
        alert("Sorry, the photo couldn't be saved. Try a different image.");
      }finally{
        saveBtn.disabled = false;
        saveSpinner.style.display = 'none';
        selectedFile = null;
        chosenFileName.textContent = "";
        // clear inputs to allow selecting same file again
        inputCam.value = "";
        inputLib.value = "";
      }
    };

    /*** Detail view ***/
    async function showDetail(i){
      viewingIndex = i;
      const t=tools[i];
      document.getElementById("detailName").innerText=t.name || "";
      document.getElementById("detailLocation").innerText=t.location || "";
      document.getElementById("detailNotes").innerText=t.notes || "";
      const di = document.getElementById("detailImage");

      di.style.display = 'none';
      try{
        if(t.id){
          const blob = await getImage(t.id);
          if(blob){
            const url = URL.createObjectURL(blob);
            di.src = url;
            di.onload = () => URL.revokeObjectURL(url);
            di.style.display = "block";
          } else if(t.imageThumb){
            di.src = t.imageThumb; di.style.display="block";
          }
        } else if(t.imageThumb){
          di.src = t.imageThumb; di.style.display="block";
        }
      }catch{
        if(t.imageThumb){ di.src = t.imageThumb; di.style.display="block"; }
      }

      showModal(detailModal);
    }
    document.getElementById("closeDetailBtn").onclick=()=>closeModal(detailModal);
    document.getElementById("copyLocationBtn").onclick=()=>{
      navigator.clipboard.writeText(document.getElementById("detailLocation").innerText);
      alert("Location copied!");
    };

    /*** Edit/Delete from detail ***/
    document.getElementById("editBtn").onclick=()=>{
      if(viewingIndex==null) return;
      const t=tools[viewingIndex];
      editingIndex=viewingIndex;
      selectedFile=null;
      chosenFileName.textContent="";
      document.getElementById("modalTitle").innerText="Edit Item";
      document.getElementById("toolName").value=t.name||"";
      document.getElementById("toolLocation").value=t.location||"";
      document.getElementById("toolNotes").value=t.notes||"";
      inputCam.value="";
      inputLib.value="";
      closeModal(detailModal);
      showModal(toolModal);
    };
    document.getElementById("deleteBtn").onclick=async ()=>{
      if(viewingIndex==null) return;
      const t=tools[viewingIndex];
      if(confirm(`Delete "${t.name}"?`)){
        tools.splice(viewingIndex,1);
        localStorage.setItem("tools", JSON.stringify(tools));
        if(t.id){ try{ await deleteImage(t.id); }catch{} }
        closeModal(detailModal);
        renderTools();
      }
    };

    /*** Search ***/
    document.getElementById("searchBar").oninput=()=>{
      const q=document.getElementById("searchBar").value.toLowerCase();
      document.querySelectorAll(".tool-card").forEach(card=>{
        card.style.display = card.innerText.toLowerCase().includes(q) ? "flex" : "none";
      });
    };

    /*** Export / Import (metadata only; images stay on each device) ***/
    document.getElementById("exportBtn").onclick=()=>{
      const blob=new Blob([JSON.stringify(tools,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");a.href=url;a.download="where-is-it-backup.json";a.click();
      URL.revokeObjectURL(url);
      alert("Exported item list. (Note: photos aren‚Äôt included and stay on this device.)");
    };
    document.getElementById("importBtn").onclick=()=>document.getElementById("importFile").click();
    document.getElementById("importFile").onchange=e=>{
      const file=e.target.files[0];
      if(file){
        const r=new FileReader();
        r.onload=()=>{
          try{
            const arr=JSON.parse(r.result);
            if(!Array.isArray(arr)) throw 0;
            tools=arr;
            localStorage.setItem("tools",JSON.stringify(tools));
            renderTools();
            alert("Imported item list. (Re-add photos on this device if needed.)");
          }catch{
            alert("Invalid file");
          }
        };
        r.readAsText(file);
      }
    };

    /*** Voice input & search ***/
    function setupVoice(btnId,targetId){
      const b=document.getElementById(btnId);
      b.onclick=()=>{
        if(!("webkitSpeechRecognition" in window)){alert("Speech not supported");return;}
        const rec=new webkitSpeechRecognition();rec.lang="en-US";rec.start();
        rec.onresult=e=>{document.getElementById(targetId).value=e.results[0][0].transcript;};
      };
    }
    setupVoice("voiceName","toolName");
    setupVoice("voiceLocation","toolLocation");
    setupVoice("voiceNotes","toolNotes");
    document.getElementById("voiceSearchBtn").onclick=()=>{
      if(!("webkitSpeechRecognition"in window)){alert("Speech not supported");return;}
      const rec=new webkitSpeechRecognition();rec.lang="en-US";rec.start();
      rec.onresult=e=>{
        const term=e.results[0][0].transcript.toLowerCase();
        document.getElementById("searchBar").value=term;
        document.getElementById("searchBar").oninput();
      };
    };

    /*** Initial render ***/
    renderTools();
  </script>

  <!-- Service worker register (keep at very end) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>

